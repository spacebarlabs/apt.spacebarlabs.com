name: Check Package Availability

on: [push, pull_request]

jobs:
  verify-packages:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update apt cache
        run: |
          sudo apt-get update

      - name: Verify all referenced packages exist
        shell: bash
        run: |
          # Script to verify that all packages referenced in Depends fields exist in Ubuntu
          
          FOUND_ERROR=0
          
          echo "=========================================="
          echo "Checking package availability in Ubuntu"
          echo "=========================================="
          
          # Loop through all package files and directories
          for ITEM in packages/*; do
            # Determine the control file path
            if [ -f "$ITEM" ]; then
              # File-based package
              CONTROL_FILE="$ITEM"
              PACKAGE_NAME=$(basename "$ITEM")
            elif [ -d "$ITEM" ]; then
              # Directory-based package
              CONTROL_FILE="$ITEM/control"
              PACKAGE_NAME=$(basename "$ITEM")
              [ -f "$CONTROL_FILE" ] || continue
            else
              continue
            fi
            
            echo ""
            echo "---------------------------------------------------"
            echo "üîç Checking $PACKAGE_NAME..."
            echo "---------------------------------------------------"
            
            # Extract the Depends field (handles multi-line dependencies)
            # This captures "Depends:" line and all indented continuation lines
            DEPENDS_LINE=$(awk '/^Depends:/ { deps=$0; getline; while ($0 ~ /^[[:space:]]/) { deps=deps" "$0; getline } print deps }' "$CONTROL_FILE")
            
            if [ -z "$DEPENDS_LINE" ]; then
              echo "   ‚ö†Ô∏è  No 'Depends:' field found. Skipping."
              continue
            fi
            
            # Extract packages from the Depends line (remove "Depends:" prefix and split by comma)
            # This handles both comma-separated and space-separated package lists
            PACKAGES=$(echo "$DEPENDS_LINE" | sed 's/^Depends://' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            
            # Check each package
            while IFS= read -r PACKAGE; do
              # Skip empty lines
              [ -z "$PACKAGE" ] && continue
              
              # Remove version constraints (e.g., "package (>= 1.0)" -> "package")
              PACKAGE_NAME=$(echo "$PACKAGE" | sed 's/[[:space:]]*(.*)//' | awk '{print $1}')
              
              # Skip if package name is empty
              [ -z "$PACKAGE_NAME" ] && continue
              
              # Skip our own sbl-* packages
              if [[ "$PACKAGE_NAME" =~ ^sbl- ]]; then
                echo "   Skipping '$PACKAGE_NAME' (internal package)"
                continue
              fi
              
              echo -n "   Checking '$PACKAGE_NAME'... "
              
              # Use apt-cache policy to check if package exists
              if apt-cache policy "$PACKAGE_NAME" 2>/dev/null | grep -q "Candidate:"; then
                # Check if there's actually a candidate version available
                CANDIDATE=$(apt-cache policy "$PACKAGE_NAME" 2>/dev/null | grep "Candidate:" | awk '{print $2}')
                if [ "$CANDIDATE" = "(none)" ]; then
                  echo "‚ùå NOT FOUND"
                  echo "      ERROR: Package '$PACKAGE_NAME' does not exist in Ubuntu repositories"
                  FOUND_ERROR=1
                else
                  echo "‚úÖ Found (version: $CANDIDATE)"
                fi
              else
                echo "‚ùå NOT FOUND"
                echo "      ERROR: Package '$PACKAGE_NAME' does not exist in Ubuntu repositories"
                FOUND_ERROR=1
              fi
            done <<< "$PACKAGES"
          done
          
          echo ""
          echo "=========================================="
          if [ "$FOUND_ERROR" -eq "1" ]; then
            echo "‚ùå FAILURE: Some packages do not exist in Ubuntu"
            echo "=========================================="
            exit 1
          else
            echo "‚úÖ SUCCESS: All packages exist in Ubuntu"
            echo "=========================================="
          fi
