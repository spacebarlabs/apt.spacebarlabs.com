name: Lint Package
on: [push, pull_request]

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Essential! We need history to see the previous commit

      - name: Verify Version Increments
        shell: bash
        run: |
          # 1. Loop through all config files in packages/
          FOUND_ERROR=0

          for FILE_PATH in packages/*; do
            # Skip if it's a directory or doesn't exist
            [ -f "$FILE_PATH" ] || continue

            echo "---------------------------------------------------"
            echo "üîç Checking $FILE_PATH..."

            # 2. Get Current Version
            NEW_VER=$(grep "^Version:" "$FILE_PATH" | head -n 1 | awk '{print $2}')

            if [ -z "$NEW_VER" ]; then
              echo "   ‚ö†Ô∏è  Skipping: No 'Version:' field found."
              continue
            fi

            # 3. Get Previous Version from Git History
            #    We use || echo "" so the script doesn't crash on new files
            OLD_VER=$(git show HEAD^:"$FILE_PATH" 2>/dev/null | grep "^Version:" | head -n 1 | awk '{print $2}')

            if [ -z "$OLD_VER" ]; then
               echo "   ‚úÖ New file detected (no previous version). Passing."
               continue
            fi

            echo "   Previous: $OLD_VER"
            echo "   Current:  $NEW_VER"

            # 4. Compare versions
            if [ "$NEW_VER" == "$OLD_VER" ]; then
               # Check if the file content actually changed.
               # If the file changed but version didn't -> ERROR.
               # If the file didn't change at all -> SKIP.
               DIFF_COUNT=$(git diff HEAD^ HEAD --name-only | grep -c "$FILE_PATH")
               if [ "$DIFF_COUNT" -eq "0" ]; then
                 echo "   Use: File not modified in this commit. Skipping."
                 continue
               else
                 echo "   ‚ùå ERROR: File modified but version not incremented!"
                 FOUND_ERROR=1
               fi
            elif dpkg --compare-versions "$NEW_VER" gt "$OLD_VER"; then
              echo "   ‚úÖ Success: Version bumped."
            else
              echo "   ‚ùå ERROR: New version is not greater than old version."
              FOUND_ERROR=1
            fi
          done

          if [ "$FOUND_ERROR" -eq "1" ]; then
            exit 1
          fi
