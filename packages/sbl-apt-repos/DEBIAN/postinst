#!/bin/bash
set -e

# Configure mise repository
echo "Configuring mise repository..."

# Create keyrings directory if it doesn't exist
install -dm 755 /etc/apt/keyrings

# Download and install mise GPG key
if [ ! -f /etc/apt/keyrings/mise-archive-keyring.asc ]; then
    curl -fsSL https://mise.jdx.dev/gpg-key.pub -o /etc/apt/keyrings/mise-archive-keyring.asc
    chmod 644 /etc/apt/keyrings/mise-archive-keyring.asc
    echo "mise GPG key installed."
else
    echo "mise GPG key already exists."
fi

# Add mise repository to sources
MISE_SOURCE="deb [signed-by=/etc/apt/keyrings/mise-archive-keyring.asc] https://mise.jdx.dev/deb stable main"
MISE_SOURCE_FILE="/etc/apt/sources.list.d/mise.list"

if [ ! -f "$MISE_SOURCE_FILE" ] || ! grep -qF "$MISE_SOURCE" "$MISE_SOURCE_FILE"; then
    echo "$MISE_SOURCE" > "$MISE_SOURCE_FILE"
    chmod 644 "$MISE_SOURCE_FILE"
    echo "mise repository added to sources."
else
    echo "mise repository already configured."
fi

# Configure Google Chrome repository
echo "Configuring Google Chrome repository..."

# Download and install Google Chrome GPG key
if [ ! -f /etc/apt/keyrings/google-chrome-archive-keyring.gpg ]; then
    curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /etc/apt/keyrings/google-chrome-archive-keyring.gpg
    chmod 644 /etc/apt/keyrings/google-chrome-archive-keyring.gpg
    echo "Google Chrome GPG key installed."
else
    echo "Google Chrome GPG key already exists."
fi

# Add Google Chrome repository to sources
CHROME_SOURCE="deb [arch=amd64 signed-by=/etc/apt/keyrings/google-chrome-archive-keyring.gpg] https://dl.google.com/linux/chrome/deb/ stable main"
CHROME_SOURCE_FILE="/etc/apt/sources.list.d/google-chrome.list"

if [ ! -f "$CHROME_SOURCE_FILE" ] || ! grep -qF "$CHROME_SOURCE" "$CHROME_SOURCE_FILE"; then
    echo "$CHROME_SOURCE" > "$CHROME_SOURCE_FILE"
    chmod 644 "$CHROME_SOURCE_FILE"
    echo "Google Chrome repository added to sources."
else
    echo "Google Chrome repository already configured."
fi

# Configure Space Bar Labs repository
echo "Configuring Space Bar Labs repository..."

SBL_SOURCE="deb [trusted=yes] https://apt.spacebarlabs.com/ ./"
SBL_SOURCE_FILE="/etc/apt/sources.list.d/spacebarlabs.list"

if [ ! -f "$SBL_SOURCE_FILE" ] || ! grep -qF "$SBL_SOURCE" "$SBL_SOURCE_FILE"; then
    echo "$SBL_SOURCE" > "$SBL_SOURCE_FILE"
    chmod 644 "$SBL_SOURCE_FILE"
    echo "Space Bar Labs repository added to sources."
else
    echo "Space Bar Labs repository already configured."
fi

# Configure Docker repository
echo "Configuring Docker repository..."

# Download and install Docker GPG key
if [ ! -f /etc/apt/keyrings/docker.asc ]; then
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    chmod 644 /etc/apt/keyrings/docker.asc
    echo "Docker GPG key installed."
else
    echo "Docker GPG key already exists."
fi

# Add Docker repository to sources
# Using DEB822 format for modern APT configuration
# Note: Only checks file existence, not content. Manual changes to the file will be preserved.
DOCKER_SOURCE_FILE="/etc/apt/sources.list.d/docker.sources"

if [ ! -f "$DOCKER_SOURCE_FILE" ]; then
    # Detect Ubuntu codename
    if [ -f /etc/os-release ]; then
        # shellcheck disable=SC1091
        . /etc/os-release
        CODENAME="${UBUNTU_CODENAME:-$VERSION_CODENAME}"
    else
        CODENAME="noble"  # Default to Ubuntu 24.04 LTS (set January 2026)
    fi
    
    cat > "$DOCKER_SOURCE_FILE" <<EOF
Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $CODENAME
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF
    chmod 644 "$DOCKER_SOURCE_FILE"
    echo "Docker repository added to sources."
else
    echo "Docker repository already configured."
fi

# Configure Signal repository
echo "Configuring Signal repository..."

# Create keyrings directory if it doesn't exist (using /usr/share/keyrings for Signal)
install -dm 755 /usr/share/keyrings

# Download and install Signal GPG key
if [ ! -f /usr/share/keyrings/signal-desktop-keyring.gpg ]; then
    if curl -fsSL https://updates.signal.org/desktop/apt/keys.asc | gpg --dearmor -o /usr/share/keyrings/signal-desktop-keyring.gpg; then
        chmod 644 /usr/share/keyrings/signal-desktop-keyring.gpg
        echo "Signal GPG key installed."
    else
        echo "Warning: Failed to download Signal GPG key. Signal repository will not be configured."
    fi
else
    echo "Signal GPG key already exists."
fi

# Add Signal repository to sources
# Download the official sources file from Signal
SIGNAL_SOURCE_FILE="/etc/apt/sources.list.d/signal-desktop.sources"

if [ ! -f "$SIGNAL_SOURCE_FILE" ] && [ -f /usr/share/keyrings/signal-desktop-keyring.gpg ]; then
    if curl -fsSL https://updates.signal.org/static/desktop/apt/signal-desktop.sources -o "$SIGNAL_SOURCE_FILE"; then
        chmod 644 "$SIGNAL_SOURCE_FILE"
        echo "Signal repository added to sources."
    else
        echo "Warning: Failed to download Signal repository configuration."
    fi
else
    if [ -f "$SIGNAL_SOURCE_FILE" ]; then
        echo "Signal repository already configured."
    fi
fi

echo "Repository configuration complete. Please run 'sudo apt update' to refresh package lists."

exit 0