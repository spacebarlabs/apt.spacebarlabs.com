name: Build and Publish APT Repo

on:
  push:
    branches:
      - main
    paths:
      - 'packages/**'
      - '.github/workflows/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push to gh-pages

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y equivs dpkg-dev

      - name: Build Packages
        run: |
          mkdir -p dist
          # Generate version from git commit timestamp
          VERSION=$(git show -s --format=%cd --date=format:'%Y%m%d%H%M' HEAD)
          echo "Using version: $VERSION"

          # Build flatpak packages from flatpaks.txt
          if [ -f "flatpaks.txt" ]; then
            echo "Building flatpak packages from flatpaks.txt..."
            
            while IFS=':' read -r pkg_name app_id || [ -n "$pkg_name" ]; do
              # Skip empty lines and comments
              [[ -z "$pkg_name" || "$pkg_name" =~ ^# ]] && continue
              
              # Trim whitespace
              pkg_name=$(echo "$pkg_name" | xargs)
              app_id=$(echo "$app_id" | xargs)
              
              package_name="sbl-flatpak-$pkg_name"
              echo "Building $package_name ($app_id)..."
              
              # Create temporary directory for package
              temp_dir=$(mktemp -d)
              cd "$temp_dir"
              
              # Convert package name to title (e.g., "emergency-alerts" -> "Emergency Alerts")
              # Using awk for portable title case conversion
              app_title=$(echo "$pkg_name" | awk '{ gsub(/-/, " "); for(i=1; i<=NF; i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2)); print }')
              
              # Generate control file from template
              sed -e "s|{{PACKAGE_NAME}}|$package_name|g" \
                  -e "s|{{APP_ID}}|$app_id|g" \
                  -e "s|{{APP_TITLE}}|$app_title|g" \
                  "$GITHUB_WORKSPACE/templates/control.template" > control
              
              # Generate postinst script from template
              sed "s|{{APP_ID}}|$app_id|g" \
                  "$GITHUB_WORKSPACE/templates/postinst.template" > postinst
              chmod +x postinst
              
              # Generate prerm script from template
              sed "s|{{APP_ID}}|$app_id|g" \
                  "$GITHUB_WORKSPACE/templates/prerm.template" > prerm
              chmod +x prerm
              
              # Add version to control file
              temp_config=$(mktemp)
              trap 'rm -f "$temp_config"' EXIT
              awk -v version="$VERSION" '
                /^Package:/ {
                  print
                  print "Version: " version
                  next
                }
                { print }
              ' control > "$temp_config"
              
              # Build package
              equivs-build "$temp_config"
              
              # Clean up temp config
              rm -f "$temp_config"
              
              # Move to dist directory
              mv *.deb "$GITHUB_WORKSPACE/dist/"
              
              # Clean up temp directory
              cd "$GITHUB_WORKSPACE"
              rm -rf "$temp_dir"
            done < flatpaks.txt
          fi

          # Build regular file-based packages from packages/
          for item in packages/*; do
            if [ -f "$item" ]; then
              # File-based package (simple meta-package)
              echo "Building file-based package $item with version $VERSION..."

              # Create temporary config with injected version
              temp_config=$(mktemp)
              trap 'rm -f "$temp_config"' EXIT
              awk -v version="$VERSION" '
                /^Package:/ {
                  print
                  print "Version: " version
                  next
                }
                { print }
              ' "$item" > "$temp_config"

              # Build package from temporary config
              equivs-build "$temp_config"

              mv *.deb dist/
            fi
          done

      - name: Generate APT Index & Metadata
        run: |
          cd dist

          # 1. Generate the Package Index
          dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz

          # 2. Generate a Release file
          # This gives your repo a nice name when users run 'apt update'
          echo "Origin: Space Bar Labs" > Release
          echo "Label: Infrastructure" >> Release
          echo "Suite: stable" >> Release
          echo "Codename: all" >> Release
          echo "Architectures: all" >> Release
          echo "Components: main" >> Release
          echo "Description: Meta-packages for my setups" >> Release
          echo "Date: $(date -Ru)" >> Release

          # 3. Create CNAME for Custom Domain
          echo "apt.spacebarlabs.com" > CNAME
          cp "../index.html" .

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          force_orphan: true # Keeps repo size small
